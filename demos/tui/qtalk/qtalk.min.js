var or=Object.defineProperty;var ar=(t,e)=>{for(var r in e)or(t,r,{get:e[r],enumerable:!0})};var cr=class{constructor(e=!1){this.debug=e}encoder(e){return new Ot(e,this.debug)}decoder(e){return new Pt(e,this.debug)}},Ot=class{constructor(e,r=!1){this.w=e,this.enc=new TextEncoder,this.debug=r}async encode(e){this.debug&&console.log("<<",e);let r=this.enc.encode(JSON.stringify(e)),n=0;for(;n<r.length;)n+=await this.w.write(r.subarray(n))}},Pt=class{constructor(e,r=!1){this.r=e,this.dec=new TextDecoder,this.debug=r}async decode(e){let r=new Uint8Array(e);if(await this.r.read(r)===null)return Promise.resolve(null);let i=JSON.parse(this.dec.decode(r));return this.debug&&console.log(">>",i),Promise.resolve(i)}};var Ne;try{Ne=new TextDecoder}catch{}var p,ie,l=0;var Rt=[],lr=105,fr=57342,dr=57343,kt=57337;var _t=6,ce={},je=Rt,Ke=0,D={},O,De,Se=0,ye=0,k,j,R=[],He=[],T,W,pe,Bt={useRecords:!1,mapsAsObjects:!0},xe=!1,Y=class{constructor(e){if(e&&((e.keyMap||e._keyMap)&&!e.useRecords&&(e.useRecords=!1,e.mapsAsObjects=!0),e.useRecords===!1&&e.mapsAsObjects===void 0&&(e.mapsAsObjects=!0),e.getStructures&&(e.getShared=e.getStructures),e.getShared&&!e.structures&&((e.structures=[]).uninitialized=!0),e.keyMap)){this.mapKey=new Map;for(let[r,n]of Object.entries(e.keyMap))this.mapKey.set(n,r)}Object.assign(this,e)}decodeKey(e){return this.keyMap&&this.mapKey.get(e)||e}encodeKey(e){return this.keyMap&&this.keyMap.hasOwnProperty(e)?this.keyMap[e]:e}encodeKeys(e){if(!this._keyMap)return e;let r=new Map;for(let[n,i]of Object.entries(e))r.set(this._keyMap.hasOwnProperty(n)?this._keyMap[n]:n,i);return r}decodeKeys(e){if(!this._keyMap||e.constructor.name!="Map")return e;if(!this._mapKey){this._mapKey=new Map;for(let[n,i]of Object.entries(this._keyMap))this._mapKey.set(i,n)}let r={};return e.forEach((n,i)=>r[v(this._mapKey.has(i)?this._mapKey.get(i):i)]=n),r}mapDecode(e,r){let n=this.decode(e);if(this._keyMap)switch(n.constructor.name){case"Array":return n.map(i=>this.decodeKeys(i))}return n}decode(e,r){if(p)return vt(()=>(Ce(),this?this.decode(e,r):Y.prototype.decode.call(Bt,e,r)));ie=r>-1?r:e.length,l=0,Ke=0,ye=0,De=null,je=Rt,k=null,p=e;try{W=e.dataView||(e.dataView=new DataView(e.buffer,e.byteOffset,e.byteLength))}catch(n){throw p=null,e instanceof Uint8Array?n:new Error("Source must be a Uint8Array or Buffer but was a "+(e&&typeof e=="object"?e.constructor.name:typeof e))}if(this instanceof Y){if(D=this,T=this.sharedValues&&(this.pack?new Array(this.maxPrivatePackedValues||16).concat(this.sharedValues):this.sharedValues),this.structures)return O=this.structures,Ee();(!O||O.length>0)&&(O=[])}else D=Bt,(!O||O.length>0)&&(O=[]),T=null;return Ee()}decodeMultiple(e,r){let n,i=0;try{let o=e.length;xe=!0;let f=this?this.decode(e,o):Ye.decode(e,o);if(r){if(r(f)===!1)return;for(;l<o;)if(i=l,r(Ee())===!1)return}else{for(n=[f];l<o;)i=l,n.push(Ee());return n}}catch(o){throw o.lastPosition=i,o.values=n,o}finally{xe=!1,Ce()}}};function Ee(){try{let t=S();if(k){if(l>=k.postBundlePosition){let e=new Error("Unexpected bundle position");throw e.incomplete=!0,e}l=k.postBundlePosition,k=null}if(l==ie)O=null,p=null,j&&(j=null);else if(l>ie){let e=new Error("Unexpected end of CBOR data");throw e.incomplete=!0,e}else if(!xe)throw new Error("Data read, but end of buffer not reached");return t}catch(t){throw Ce(),(t instanceof RangeError||t.message.startsWith("Unexpected end of buffer"))&&(t.incomplete=!0),t}}function S(){let t=p[l++],e=t>>5;if(t=t&31,t>23)switch(t){case 24:t=p[l++];break;case 25:if(e==7)return pr();t=W.getUint16(l),l+=2;break;case 26:if(e==7){let r=W.getFloat32(l);if(D.useFloat32>2){let n=Me[(p[l]&127)<<1|p[l+1]>>7];return l+=4,(n*r+(r>0?.5:-.5)>>0)/n}return l+=4,r}t=W.getUint32(l),l+=4;break;case 27:if(e==7){let r=W.getFloat64(l);return l+=8,r}if(e>1){if(W.getUint32(l)>0)throw new Error("JavaScript does not support arrays, maps, or strings with length over 4294967295");t=W.getUint32(l+4)}else D.int64AsNumber?(t=W.getUint32(l)*4294967296,t+=W.getUint32(l+4)):t=W.getBigUint64(l);l+=8;break;case 31:switch(e){case 2:case 3:throw new Error("Indefinite length not supported for byte or text strings");case 4:let r=[],n,i=0;for(;(n=S())!=ce;)r[i++]=n;return e==4?r:e==3?r.join(""):Buffer.concat(r);case 5:let o;if(D.mapsAsObjects){let f={};if(D.keyMap)for(;(o=S())!=ce;)f[v(D.decodeKey(o))]=S();else for(;(o=S())!=ce;)f[v(o)]=S();return f}else{pe&&(D.mapsAsObjects=!0,pe=!1);let f=new Map;if(D.keyMap)for(;(o=S())!=ce;)f.set(D.decodeKey(o),S());else for(;(o=S())!=ce;)f.set(o,S());return f}case 7:return ce;default:throw new Error("Invalid major type for indefinite length "+e)}default:throw new Error("Unknown token "+t)}switch(e){case 0:return t;case 1:return~t;case 2:return yr(t);case 3:if(ye>=l)return De.slice(l-Se,(l+=t)-Se);if(ye==0&&ie<140&&t<32){let i=t<16?Wt(t):hr(t);if(i!=null)return i}return ur(t);case 4:let r=new Array(t);for(let i=0;i<t;i++)r[i]=S();return r;case 5:if(D.mapsAsObjects){let i={};if(D.keyMap)for(let o=0;o<t;o++)i[v(D.decodeKey(S()))]=S();else for(let o=0;o<t;o++)i[v(S())]=S();return i}else{pe&&(D.mapsAsObjects=!0,pe=!1);let i=new Map;if(D.keyMap)for(let o=0;o<t;o++)i.set(D.decodeKey(S()),S());else for(let o=0;o<t;o++)i.set(S(),S());return i}case 6:if(t>=kt){let i=O[t&8191];if(i)return i.read||(i.read=qe(i)),i.read();if(t<65536){if(t==dr){let o=fe(),f=S(),m=S();Ge(f,m);let g={};if(D.keyMap)for(let x=2;x<o;x++){let P=D.decodeKey(m[x-2]);g[v(P)]=S()}else for(let x=2;x<o;x++){let P=m[x-2];g[v(P)]=S()}return g}else if(t==fr){let o=fe(),f=S();for(let m=2;m<o;m++)Ge(f++,S());return S()}else if(t==kt)return Ir();if(D.getShared&&(Je(),i=O[t&8191],i))return i.read||(i.read=qe(i)),i.read()}}let n=R[t];if(n)return n.handlesRead?n(S):n(S());{let i=S();for(let o=0;o<He.length;o++){let f=He[o](t,i);if(f!==void 0)return f}return new K(i,t)}case 7:switch(t){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 31:default:let i=(T||oe())[t];if(i!==void 0)return i;throw new Error("Unknown token "+t)}default:if(isNaN(t)){let i=new Error("Unexpected end of CBOR data");throw i.incomplete=!0,i}throw new Error("Unknown CBOR token "+t)}}var Ft=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function qe(t){function e(){let r=p[l++];if(r=r&31,r>23)switch(r){case 24:r=p[l++];break;case 25:r=W.getUint16(l),l+=2;break;case 26:r=W.getUint32(l),l+=4;break;default:throw new Error("Expected array header, but got "+p[l-1])}let n=this.compiledReader;for(;n;){if(n.propertyCount===r)return n(S);n=n.next}if(this.slowReads++>=3){let o=this.length==r?this:this.slice(0,r);return n=D.keyMap?new Function("r","return {"+o.map(f=>D.decodeKey(f)).map(f=>Ft.test(f)?v(f)+":r()":"["+JSON.stringify(f)+"]:r()").join(",")+"}"):new Function("r","return {"+o.map(f=>Ft.test(f)?v(f)+":r()":"["+JSON.stringify(f)+"]:r()").join(",")+"}"),this.compiledReader&&(n.next=this.compiledReader),n.propertyCount=r,this.compiledReader=n,n(S)}let i={};if(D.keyMap)for(let o=0;o<r;o++)i[v(D.decodeKey(this[o]))]=S();else for(let o=0;o<r;o++)i[v(this[o])]=S();return i}return t.slowReads=0,e}function v(t){return t==="__proto__"?"__proto_":t}var ur=$e;function $e(t){let e;if(t<16&&(e=Wt(t)))return e;if(t>64&&Ne)return Ne.decode(p.subarray(l,l+=t));let r=l+t,n=[];for(e="";l<r;){let i=p[l++];if((i&128)===0)n.push(i);else if((i&224)===192){let o=p[l++]&63;n.push((i&31)<<6|o)}else if((i&240)===224){let o=p[l++]&63,f=p[l++]&63;n.push((i&31)<<12|o<<6|f)}else if((i&248)===240){let o=p[l++]&63,f=p[l++]&63,m=p[l++]&63,g=(i&7)<<18|o<<12|f<<6|m;g>65535&&(g-=65536,n.push(g>>>10&1023|55296),g=56320|g&1023),n.push(g)}else n.push(i);n.length>=4096&&(e+=B.apply(String,n),n.length=0)}return n.length>0&&(e+=B.apply(String,n)),e}var B=String.fromCharCode;function hr(t){let e=l,r=new Array(t);for(let n=0;n<t;n++){let i=p[l++];if((i&128)>0){l=e;return}r[n]=i}return B.apply(String,r)}function Wt(t){if(t<4)if(t<2){if(t===0)return"";{let e=p[l++];if((e&128)>1){l-=1;return}return B(e)}}else{let e=p[l++],r=p[l++];if((e&128)>0||(r&128)>0){l-=2;return}if(t<3)return B(e,r);let n=p[l++];if((n&128)>0){l-=3;return}return B(e,r,n)}else{let e=p[l++],r=p[l++],n=p[l++],i=p[l++];if((e&128)>0||(r&128)>0||(n&128)>0||(i&128)>0){l-=4;return}if(t<6){if(t===4)return B(e,r,n,i);{let o=p[l++];if((o&128)>0){l-=5;return}return B(e,r,n,i,o)}}else if(t<8){let o=p[l++],f=p[l++];if((o&128)>0||(f&128)>0){l-=6;return}if(t<7)return B(e,r,n,i,o,f);let m=p[l++];if((m&128)>0){l-=7;return}return B(e,r,n,i,o,f,m)}else{let o=p[l++],f=p[l++],m=p[l++],g=p[l++];if((o&128)>0||(f&128)>0||(m&128)>0||(g&128)>0){l-=8;return}if(t<10){if(t===8)return B(e,r,n,i,o,f,m,g);{let x=p[l++];if((x&128)>0){l-=9;return}return B(e,r,n,i,o,f,m,g,x)}}else if(t<12){let x=p[l++],P=p[l++];if((x&128)>0||(P&128)>0){l-=10;return}if(t<11)return B(e,r,n,i,o,f,m,g,x,P);let C=p[l++];if((C&128)>0){l-=11;return}return B(e,r,n,i,o,f,m,g,x,P,C)}else{let x=p[l++],P=p[l++],C=p[l++],L=p[l++];if((x&128)>0||(P&128)>0||(C&128)>0||(L&128)>0){l-=12;return}if(t<14){if(t===12)return B(e,r,n,i,o,f,m,g,x,P,C,L);{let F=p[l++];if((F&128)>0){l-=13;return}return B(e,r,n,i,o,f,m,g,x,P,C,L,F)}}else{let F=p[l++],z=p[l++];if((F&128)>0||(z&128)>0){l-=14;return}if(t<15)return B(e,r,n,i,o,f,m,g,x,P,C,L,F,z);let G=p[l++];if((G&128)>0){l-=15;return}return B(e,r,n,i,o,f,m,g,x,P,C,L,F,z,G)}}}}}function yr(t){return D.copyBuffers?Uint8Array.prototype.slice.call(p,l,l+=t):p.subarray(l,l+=t)}var Tt=new Float32Array(1),Ue=new Uint8Array(Tt.buffer,0,4);function pr(){let t=p[l++],e=p[l++],r=(t&127)>>2;if(r===31)return e||t&3?NaN:t&128?-1/0:1/0;if(r===0){let n=((t&3)<<8|e)/(1<<24);return t&128?-n:n}return Ue[3]=t&128|(r>>1)+56,Ue[2]=(t&7)<<5|e>>3,Ue[1]=e<<5,Ue[0]=0,Tt[0]}var jr=new Array(4096);var K=class{constructor(e,r){this.value=e,this.tag=r}};R[0]=t=>new Date(t);R[1]=t=>new Date(Math.round(t*1e3));R[2]=t=>{let e=BigInt(0);for(let r=0,n=t.byteLength;r<n;r++)e=BigInt(t[r])+e<<BigInt(8);return e};R[3]=t=>BigInt(-1)-R[2](t);R[4]=t=>+(t[1]+"e"+t[0]);R[5]=t=>t[1]*Math.exp(t[0]*Math.log(2));var Ge=(t,e)=>{t=t-57344;let r=O[t];r&&r.isShared&&((O.restoreStructures||(O.restoreStructures=[]))[t]=r),O[t]=e,e.read=qe(e)};R[lr]=t=>{let e=t.length,r=t[1];Ge(t[0],r);let n={};for(let i=2;i<e;i++){let o=r[i-2];n[v(o)]=t[i]}return n};R[14]=t=>k?k[0].slice(k.position0,k.position0+=t):new K(t,14);R[15]=t=>k?k[1].slice(k.position1,k.position1+=t):new K(t,15);var xr={Error,RegExp};R[27]=t=>(xr[t[0]]||Error)(t[1],t[2]);var Vt=t=>{if(p[l++]!=132)throw new Error("Packed values structure must be followed by a 4 element array");let e=t();return T=T?e.concat(T.slice(e.length)):e,T.prefixes=t(),T.suffixes=t(),t()};Vt.handlesRead=!0;R[51]=Vt;R[_t]=t=>{if(!T)if(D.getShared)Je();else return new K(t,_t);if(typeof t=="number")return T[16+(t>=0?2*t:-2*t-1)];throw new Error("No support for non-integer packed references yet")};R[28]=t=>{j||(j=new Map,j.id=0);let e=j.id++,r=p[l],n;r>>5==4?n=[]:n={};let i={target:n};j.set(e,i);let o=t();return i.used?Object.assign(n,o):(i.target=o,o)};R[28].handlesRead=!0;R[29]=t=>{let e=j.get(t);return e.used=!0,e.target};R[258]=t=>new Set(t);(R[259]=t=>(D.mapsAsObjects&&(D.mapsAsObjects=!1,pe=!0),t())).handlesRead=!0;function le(t,e){return typeof t=="string"?t+e:t instanceof Array?t.concat(e):Object.assign({},t,e)}function oe(){if(!T)if(D.getShared)Je();else throw new Error("No packed values available");return T}var mr=1399353956;He.push((t,e)=>{if(t>=225&&t<=255)return le(oe().prefixes[t-224],e);if(t>=28704&&t<=32767)return le(oe().prefixes[t-28672],e);if(t>=1879052288&&t<=2147483647)return le(oe().prefixes[t-1879048192],e);if(t>=216&&t<=223)return le(e,oe().suffixes[t-216]);if(t>=27647&&t<=28671)return le(e,oe().suffixes[t-27639]);if(t>=1811940352&&t<=1879048191)return le(e,oe().suffixes[t-1811939328]);if(t==mr)return{packedValues:T,structures:O.slice(0),version:e};if(t==55799)return e});var wr=new Uint8Array(new Uint16Array([1]).buffer)[0]==1,Lt=[Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,typeof BigUint64Array=="undefined"?{name:"BigUint64Array"}:BigUint64Array,Int8Array,Int16Array,Int32Array,typeof BigInt64Array=="undefined"?{name:"BigInt64Array"}:BigInt64Array,Float32Array,Float64Array],gr=[64,68,69,70,71,72,77,78,79,85,86];for(let t=0;t<Lt.length;t++)br(Lt[t],gr[t]);function br(t,e){let r="get"+t.name.slice(0,-5);typeof t!="function"&&(t=null);let n=t.BYTES_PER_ELEMENT;for(let i=0;i<2;i++){if(!i&&n==1)continue;let o=n==2?1:n==4?2:3;R[i?e:e-4]=n==1||i==wr?f=>{if(!t)throw new Error("Could not find typed array for code "+e);return new t(Uint8Array.prototype.slice.call(f,0).buffer)}:f=>{if(!t)throw new Error("Could not find typed array for code "+e);let m=new DataView(f.buffer,f.byteOffset,f.byteLength),g=f.length>>o,x=new t(g),P=m[r];for(let C=0;C<g;C++)x[C]=P.call(m,C<<o,i);return x}}}function Ir(){let t=fe(),e=l+S();for(let n=2;n<t;n++)l+=fe();let r=l;return l=e,k=[$e(fe()),$e(fe())],k.position0=0,k.position1=0,k.postBundlePosition=l,l=r,S()}function fe(){let t=p[l++]&31;if(t>23)switch(t){case 24:t=p[l++];break;case 25:t=W.getUint16(l),l+=2;break;case 26:t=W.getUint32(l),l+=4;break}return t}function Je(){if(D.getShared){let t=vt(()=>(p=null,D.getShared()))||{},e=t.structures||[];D.sharedVersion=t.version,T=D.sharedValues=t.packedValues,O===!0?D.structures=O=e:O.splice.apply(O,[0,e.length].concat(e))}}function vt(t){let e=ie,r=l,n=Ke,i=Se,o=ye,f=De,m=je,g=j,x=k,P=new Uint8Array(p.slice(0,ie)),C=O,L=D,F=xe,z=t();return ie=e,l=r,Ke=n,Se=i,ye=o,De=f,je=m,j=g,k=x,p=P,xe=F,O=C,D=L,W=new DataView(p.buffer,p.byteOffset,p.byteLength),z}function Ce(){p=null,j=null,O=null}var Me=new Array(147);for(let t=0;t<256;t++)Me[t]=+("1e"+Math.floor(45.15-t*.30103));var Ye=new Y({useRecords:!1}),Xe=Ye.decode,Ar=Ye.decodeMultiple;var Oe;try{Oe=new TextEncoder}catch{}var Ze,Nt,Pe=globalThis.Buffer,me=typeof Pe!="undefined",Qe=me?Pe.allocUnsafeSlow:Uint8Array,jt=me?Pe:Uint8Array,Kt=256,Ht=me?4294967296:2144337920;var et,a,M,s=0,te,_=null,Dr=61440,Sr=/[\u0080-\uFFFF]/,V=Symbol("record-id"),Re=class extends Y{constructor(e){super(e);this.offset=0;let r,n,i,o,f,m;e=e||{};let g=jt.prototype.utf8Write?function(c,y,d){return a.utf8Write(c,y,d)}:Oe&&Oe.encodeInto?function(c,y){return Oe.encodeInto(c,a.subarray(y)).written}:!1,x=this,P=e.structures||e.saveStructures,C=e.maxSharedStructures;if(C==null&&(C=P?128:0),C>8190)throw new Error("Maximum maxSharedStructure is 8190");let L=e.sequential;L&&(C=0),this.structures||(this.structures=[]),this.saveStructures&&(this.saveShared=this.saveStructures);let F,z,G=e.sharedValues,N;if(G){N=Object.create(null);for(let c=0,y=G.length;c<y;c++)N[G[c]]=c}let J=[],Le=0,Ae=0;this.mapEncode=function(c,y){if(this._keyMap&&!this._mapped)switch(c.constructor.name){case"Array":c=c.map(d=>this.encodeKeys(d));break}return this.encode(c,y)},this.encode=function(c,y){if(a||(a=new Qe(8192),M=new DataView(a.buffer,0,8192),s=0),te=a.length-10,te-s<2048?(a=new Qe(a.length),M=new DataView(a.buffer,0,a.length),te=a.length-10,s=0):y===it&&(s=s+7&2147483640),n=s,x.useSelfDescribedHeader&&(M.setUint32(s,3654940416),s+=3),m=x.structuredClone?new Map:null,x.bundleStrings&&typeof c!="string"?(_=[],_.size=1/0):_=null,i=x.structures,i){if(i.uninitialized){let h=x.getShared()||{};x.structures=i=h.structures||[],x.sharedVersion=h.version;let u=x.sharedValues=h.packedValues;if(u){N={};for(let w=0,b=u.length;w<b;w++)N[u[w]]=w}}let d=i.length;if(d>C&&!L&&(d=C),!i.transitions){i.transitions=Object.create(null);for(let h=0;h<d;h++){let u=i[h];if(!u)continue;let w,b=i.transitions;for(let I=0,A=u.length;I<A;I++){b[V]===void 0&&(b[V]=h);let E=u[I];w=b[E],w||(w=b[E]=Object.create(null)),b=w}b[V]=h|1048576}}L||(i.nextId=d)}if(o&&(o=!1),f=i||[],z=N,e.pack){let d=new Map;if(d.values=[],d.encoder=x,d.maxValues=e.maxPrivatePackedValues||(N?16:1/0),d.objectMap=N||!1,d.samplingPackedValues=F,ke(c,d),d.values.length>0){a[s++]=216,a[s++]=51,H(4);let h=d.values;U(h),H(0),H(0),z=Object.create(N||null);for(let u=0,w=h.length;u<w;u++)z[h[u]]=u}}et=y&ot;try{if(et)return;if(U(c),_&&Gt(n,U),x.offset=s,m&&m.idsToInsert){s+=m.idsToInsert.length*2,s>te&&ue(s),x.offset=s;let d=Cr(a.subarray(n,s),m.idsToInsert);return m=null,d}return y&it?(a.start=n,a.end=s,a):a.subarray(n,s)}finally{if(i){if(Ae<10&&Ae++,i.length>C&&(i.length=C),Le>1e4)i.transitions=null,Ae=0,Le=0,J.length>0&&(J=[]);else if(J.length>0&&!L){for(let d=0,h=J.length;d<h;d++)J[d][V]=void 0;J=[]}}if(o&&x.saveShared){x.structures.length>C&&(x.structures=x.structures.slice(0,C));let d=a.subarray(n,s);return x.updateSharedData()===!1?x.encode(c):d}y&Pr&&(s=n)}},this.findCommonStringsToPack=()=>(F=new Map,N||(N=Object.create(null)),c=>{let y=c&&c.threshold||4,d=this.pack?c.maxPrivatePackedValues||16:0;G||(G=this.sharedValues=[]);for(let[h,u]of F)u.count>y&&(N[h]=d++,G.push(h),o=!0);for(;this.saveShared&&this.updateSharedData()===!1;);F=null});let U=c=>{s>te&&(a=ue(s));var y=typeof c,d;if(y==="string"){if(z){let b=z[c];if(b>=0){b<16?a[s++]=b+224:(a[s++]=198,b&1?U(15-b>>1):U(b-16>>1));return}else if(F&&!e.pack){let I=F.get(c);I?I.count++:F.set(c,{count:1})}}let h=c.length;if(_&&h>=4&&h<1024){if((_.size+=h)>Dr){let I,A=(_[0]?_[0].length*3+_[1].length:0)+10;s+A>te&&(a=ue(s+A)),a[s++]=217,a[s++]=223,a[s++]=249,a[s++]=_.position?132:130,a[s++]=26,I=s-n,s+=4,_.position&&Gt(n,U),_=["",""],_.size=0,_.position=I}let b=Sr.test(c);_[b?0:1]+=c,a[s++]=b?206:207,U(h);return}let u;h<32?u=1:h<256?u=2:h<65536?u=3:u=5;let w=h*3;if(s+w>te&&(a=ue(s+w)),h<64||!g){let b,I,A,E=s+u;for(b=0;b<h;b++)I=c.charCodeAt(b),I<128?a[E++]=I:I<2048?(a[E++]=I>>6|192,a[E++]=I&63|128):(I&64512)===55296&&((A=c.charCodeAt(b+1))&64512)===56320?(I=65536+((I&1023)<<10)+(A&1023),b++,a[E++]=I>>18|240,a[E++]=I>>12&63|128,a[E++]=I>>6&63|128,a[E++]=I&63|128):(a[E++]=I>>12|224,a[E++]=I>>6&63|128,a[E++]=I&63|128);d=E-s-u}else d=g(c,s+u,w);d<24?a[s++]=96|d:d<256?(u<2&&a.copyWithin(s+2,s+1,s+1+d),a[s++]=120,a[s++]=d):d<65536?(u<3&&a.copyWithin(s+3,s+2,s+2+d),a[s++]=121,a[s++]=d>>8,a[s++]=d&255):(u<5&&a.copyWithin(s+5,s+3,s+3+d),a[s++]=122,M.setUint32(s,d),s+=4),s+=d}else if(y==="number")if(!this.alwaysUseFloat&&c>>>0===c)c<24?a[s++]=c:c<256?(a[s++]=24,a[s++]=c):c<65536?(a[s++]=25,a[s++]=c>>8,a[s++]=c&255):(a[s++]=26,M.setUint32(s,c),s+=4);else if(!this.alwaysUseFloat&&c>>0===c)c>=-24?a[s++]=31-c:c>=-256?(a[s++]=56,a[s++]=~c):c>=-65536?(a[s++]=57,M.setUint16(s,~c),s+=2):(a[s++]=58,M.setUint32(s,~c),s+=4);else{let h;if((h=this.useFloat32)>0&&c<4294967296&&c>=-2147483648){a[s++]=250,M.setFloat32(s,c);let u;if(h<4||(u=c*Me[(a[s]&127)<<1|a[s+1]>>7])>>0===u){s+=4;return}else s--}a[s++]=251,M.setFloat64(s,c),s+=8}else if(y==="object")if(!c)a[s++]=246;else{if(m){let u=m.get(c);if(u){if(a[s++]=216,a[s++]=29,a[s++]=25,!u.references){let w=m.idsToInsert||(m.idsToInsert=[]);u.references=[],w.push(u)}u.references.push(s-n),s+=2;return}else m.set(c,{offset:s-n})}let h=c.constructor;if(h===Object)ve(c,!0);else if(h===Array){d=c.length,d<24?a[s++]=128|d:H(d);for(let u=0;u<d;u++)U(c[u])}else if(h===Map)if((this.mapsAsObjects?this.useTag259ForMaps!==!1:this.useTag259ForMaps)&&(a[s++]=217,a[s++]=1,a[s++]=3),d=c.size,d<24?a[s++]=160|d:d<256?(a[s++]=184,a[s++]=d):d<65536?(a[s++]=185,a[s++]=d>>8,a[s++]=d&255):(a[s++]=186,M.setUint32(s,d),s+=4),x.keyMap)for(let[u,w]of c)U(x.encodeKey(u)),U(w);else for(let[u,w]of c)U(u),U(w);else{for(let u=0,w=Ze.length;u<w;u++){let b=Nt[u];if(c instanceof b){let I=Ze[u],A=I.tag;A==null&&(A=I.getTag&&I.getTag.call(this,c)),A<24?a[s++]=192|A:A<256?(a[s++]=216,a[s++]=A):A<65536?(a[s++]=217,a[s++]=A>>8,a[s++]=A&255):A>-1&&(a[s++]=218,M.setUint32(s,A),s+=4),I.encode.call(this,c,U,ue);return}}if(c[Symbol.iterator]){if(et){let u=new Error("Iterable should be serialized as iterator");throw u.iteratorNotHandled=!0,u}a[s++]=159;for(let u of c)U(u);a[s++]=255;return}if(c[Symbol.asyncIterator]||rt(c)){let u=new Error("Iterable/blob should be serialized as iterator");throw u.iteratorNotHandled=!0,u}ve(c,!c.hasOwnProperty)}}else if(y==="boolean")a[s++]=c?245:244;else if(y==="bigint"){if(c<BigInt(1)<<BigInt(64)&&c>=0)a[s++]=27,M.setBigUint64(s,c);else if(c>-(BigInt(1)<<BigInt(64))&&c<0)a[s++]=59,M.setBigUint64(s,-c-BigInt(1));else if(this.largeBigIntToFloat)a[s++]=251,M.setFloat64(s,Number(c));else throw new RangeError(c+" was too large to fit in CBOR 64-bit integer format, set largeBigIntToFloat to convert to float-64");s+=8}else if(y==="undefined")a[s++]=247;else throw new Error("Unknown type: "+y)},ve=this.useRecords===!1?this.variableMapSize?c=>{let y=Object.keys(c),d=Object.values(c),h=y.length;h<24?a[s++]=160|h:h<256?(a[s++]=184,a[s++]=h):h<65536?(a[s++]=185,a[s++]=h>>8,a[s++]=h&255):(a[s++]=186,M.setUint32(s,h),s+=4);let u;if(x.keyMap)for(let w=0;w<h;w++)U(encodeKey(y[w])),U(d[w]);else for(let w=0;w<h;w++)U(y[w]),U(d[w])}:(c,y)=>{a[s++]=185;let d=s-n;s+=2;let h=0;if(x.keyMap)for(let u in c)(y||c.hasOwnProperty(u))&&(U(x.encodeKey(u)),U(c[u]),h++);else for(let u in c)(y||c.hasOwnProperty(u))&&(U(u),U(c[u]),h++);a[d+++n]=h>>8,a[d+n]=h&255}:(c,y)=>{let d,h=f.transitions||(f.transitions=Object.create(null)),u=0,w=0,b,I;if(this.keyMap){I=Object.keys(c).map(E=>this.encodeKey(E)),w=I.length;for(let E=0;E<w;E++){let Mt=I[E];d=h[Mt],d||(d=h[Mt]=Object.create(null),u++),h=d}}else for(let E in c)(y||c.hasOwnProperty(E))&&(d=h[E],d||(h[V]&1048576&&(b=h[V]&65535),d=h[E]=Object.create(null),u++),h=d,w++);let A=h[V];if(A!==void 0)A&=65535,a[s++]=217,a[s++]=A>>8|224,a[s++]=A&255;else if(I||(I=h.__keys__||(h.__keys__=Object.keys(c))),b===void 0?(A=f.nextId++,A||(A=0,f.nextId=1),A>=Kt&&(f.nextId=(A=C)+1)):A=b,f[A]=I,A<C){a[s++]=217,a[s++]=A>>8|224,a[s++]=A&255,h=f.transitions;for(let E=0;E<w;E++)(h[V]===void 0||h[V]&1048576)&&(h[V]=A),h=h[I[E]];h[V]=A|1048576,o=!0}else{if(h[V]=A,M.setUint32(s,3655335680),s+=3,u&&(Le+=Ae*u),J.length>=Kt-C&&(J.shift()[V]=void 0),J.push(h),H(w+2),U(57344+A),U(I),y===null)return;for(let E in c)(y||c.hasOwnProperty(E))&&U(c[E]);return}if(w<24?a[s++]=128|w:H(w),y!==null)for(let E in c)(y||c.hasOwnProperty(E))&&U(c[E])},ue=c=>{let y;if(c>16777216){if(c-n>Ht)throw new Error("Encoded buffer would be larger than maximum buffer size");y=Math.min(Ht,Math.round(Math.max((c-n)*(c>67108864?1.25:2),4194304)/4096)*4096)}else y=(Math.max(c-n<<2,a.length-1)>>12)+1<<12;let d=new Qe(y);return M=new DataView(d.buffer,0,y),a.copy?a.copy(d,0,n,c):d.set(a.slice(n,c)),s-=n,n=0,te=d.length-10,a=d},se=100,Et=1e3;this.encodeAsIterable=function(c,y){return Ut(c,y,ae)},this.encodeAsAsyncIterable=function(c,y){return Ut(c,y,Ct)};function*ae(c,y,d){let h=c.constructor;if(h===Object){let u=x.useRecords!==!1;u?ve(c,null):qt(Object.keys(c).length,160);for(let w in c){let b=c[w];u||U(w),b&&typeof b=="object"?y[w]?yield*ae(b,y[w]):yield*ze(b,y,w):U(b)}}else if(h===Array){let u=c.length;H(u);for(let w=0;w<u;w++){let b=c[w];b&&(typeof b=="object"||s-n>se)?y.element?yield*ae(b,y.element):yield*ze(b,y,"element"):U(b)}}else if(c[Symbol.iterator]){a[s++]=159;for(let u of c)u&&(typeof u=="object"||s-n>se)?y.element?yield*ae(u,y.element):yield*ze(u,y,"element"):U(u);a[s++]=255}else rt(c)?(qt(c.size,64),yield a.subarray(n,s),yield c,he()):c[Symbol.asyncIterator]?(a[s++]=159,yield a.subarray(n,s),yield c,he(),a[s++]=255):U(c);d&&s>n?yield a.subarray(n,s):s-n>se&&(yield a.subarray(n,s),he())}function*ze(c,y,d){let h=s-n;try{U(c),s-n>se&&(yield a.subarray(n,s),he())}catch(u){if(u.iteratorNotHandled)y[d]={},s=n+h,yield*ae.call(this,c,y[d]);else throw u}}function he(){se=Et,x.encode(null,ot)}function Ut(c,y,d){return y&&y.chunkThreshold?se=Et=y.chunkThreshold:se=100,c&&typeof c=="object"?(x.encode(null,ot),d(c,x.iterateProperties||(x.iterateProperties={}),!0)):[x.encode(c)]}async function*Ct(c,y){for(let d of ae(c,y,!0)){let h=d.constructor;if(h===jt||h===Uint8Array)yield d;else if(rt(d)){let u=d.stream().getReader(),w;for(;!(w=await u.read()).done;)yield w.value}else if(d[Symbol.asyncIterator])for await(let u of d)he(),u?yield*Ct(u,y.async||(y.async={})):yield x.encode(u);else yield d}}}useBuffer(e){a=e,M=new DataView(a.buffer,a.byteOffset,a.byteLength),s=0}clearSharedData(){this.structures&&(this.structures=[]),this.sharedValues&&(this.sharedValues=void 0)}updateSharedData(){let e=this.sharedVersion||0;this.sharedVersion=e+1;let r=this.structures.slice(0),n=new tt(r,this.sharedValues,this.sharedVersion),i=this.saveShared(n,o=>(o&&o.version||0)==e);return i===!1?(n=this.getShared()||{},this.structures=n.structures||[],this.sharedValues=n.packedValues,this.sharedVersion=n.version,this.structures.nextId=this.structures.length):r.forEach((o,f)=>this.structures[f]=o),i}};function qt(t,e){t<24?a[s++]=e|t:t<256?(a[s++]=e|24,a[s++]=t):t<65536?(a[s++]=e|25,a[s++]=t>>8,a[s++]=t&255):(a[s++]=e|26,M.setUint32(s,t),s+=4)}var tt=class{constructor(e,r,n){this.structures=e,this.packedValues=r,this.version=n}};function H(t){t<24?a[s++]=128|t:t<256?(a[s++]=152,a[s++]=t):t<65536?(a[s++]=153,a[s++]=t>>8,a[s++]=t&255):(a[s++]=154,M.setUint32(s,t),s+=4)}var Er=typeof Blob=="undefined"?function(){}:Blob;function rt(t){if(t instanceof Er)return!0;let e=t[Symbol.toStringTag];return e==="Blob"||e==="File"}function ke(t,e){switch(typeof t){case"string":if(t.length>3){if(e.objectMap[t]>-1||e.values.length>=e.maxValues)return;let n=e.get(t);if(n)++n.count==2&&e.values.push(t);else if(e.set(t,{count:1}),e.samplingPackedValues){let i=e.samplingPackedValues.get(t);i?i.count++:e.samplingPackedValues.set(t,{count:1})}}break;case"object":if(t)if(t instanceof Array)for(let n=0,i=t.length;n<i;n++)ke(t[n],e);else{let n=!e.encoder.useRecords;for(var r in t)t.hasOwnProperty(r)&&(n&&ke(r,e),ke(t[r],e))}break;case"function":console.log(t)}}var Ur=new Uint8Array(new Uint16Array([1]).buffer)[0]==1;Nt=[Date,Set,Error,RegExp,K,ArrayBuffer,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,typeof BigUint64Array=="undefined"?function(){}:BigUint64Array,Int8Array,Int16Array,Int32Array,typeof BigInt64Array=="undefined"?function(){}:BigInt64Array,Float32Array,Float64Array,tt];Ze=[{tag:1,encode(t,e){let r=t.getTime()/1e3;(this.useTimestamp32||t.getMilliseconds()===0)&&r>=0&&r<4294967296?(a[s++]=26,M.setUint32(s,r),s+=4):(a[s++]=251,M.setFloat64(s,r),s+=8)}},{tag:258,encode(t,e){let r=Array.from(t);e(r)}},{tag:27,encode(t,e){e([t.name,t.message])}},{tag:27,encode(t,e){e(["RegExp",t.source,t.flags])}},{getTag(t){return t.tag},encode(t,e){e(t.value)}},{encode(t,e,r){$t(t,r)}},{getTag(t){if(t.constructor===Uint8Array&&(this.tagUint8Array||me&&this.tagUint8Array!==!1))return 64},encode(t,e,r){$t(t,r)}},q(68,1),q(69,2),q(70,4),q(71,8),q(72,1),q(77,2),q(78,4),q(79,8),q(85,4),q(86,8),{encode(t,e){let r=t.packedValues||[],n=t.structures||[];if(r.values.length>0){a[s++]=216,a[s++]=51,H(4);let i=r.values;e(i),H(0),H(0),packedObjectMap=Object.create(sharedPackedObjectMap||null);for(let o=0,f=i.length;o<f;o++)packedObjectMap[i[o]]=o}if(n){M.setUint32(s,3655335424),s+=3;let i=n.slice(0);i.unshift(57344),i.push(new K(t.version,1399353956)),e(i)}else e(new K(t.version,1399353956))}}];function q(t,e){return!Ur&&e>1&&(t-=4),{tag:t,encode:function(n,i){let o=n.byteLength,f=n.byteOffset||0,m=n.buffer||n;i(me?Pe.from(m,f,o):new Uint8Array(m,f,o))}}}function $t(t,e){let r=t.byteLength;r<24?a[s++]=64+r:r<256?(a[s++]=88,a[s++]=r):r<65536?(a[s++]=89,a[s++]=r>>8,a[s++]=r&255):(a[s++]=90,M.setUint32(s,r),s+=4),s+r>=a.length&&e(s+r),a.set(t.buffer?t:new Uint8Array(t),s),s+=r}function Cr(t,e){let r,n=e.length*2,i=t.length-n;e.sort((o,f)=>o.offset>f.offset?1:-1);for(let o=0;o<e.length;o++){let f=e[o];f.id=o;for(let m of f.references)t[m++]=o>>8,t[m]=o&255}for(;r=e.pop();){let o=r.offset;t.copyWithin(o+n,o,i),n-=2;let f=o+n;t[f++]=216,t[f++]=28,i=o}return t}function Gt(t,e){M.setUint32(_.position+t,s-_.position-t+1);let r=_;_=null,e(r[0]),e(r[1])}var nt=new Re({useRecords:!1}),st=nt.encode,Mr=nt.encodeAsIterable,Or=nt.encodeAsAsyncIterable;var it=512,Pr=1024,ot=2048;var Rr=class{constructor(e=!1){this.debug=e}encoder(e){return new Jt(e,this.debug)}decoder(e){return new Yt(e,this.debug)}},Jt=class{constructor(e,r=!1){this.w=e,this.debug=r}async encode(e){this.debug&&console.log("<<",e);let r=st(e),n=0;for(;n<r.length;)n+=await this.w.write(r.subarray(n))}},Yt=class{constructor(e,r=!1){this.r=e,this.debug=r}async decode(e){let r=new Uint8Array(e);if(await this.r.read(r)===null)return Promise.resolve(null);let i=Xe(r);return this.debug&&console.log(">>",i),Promise.resolve(i)}};function _e(t,e,r=0){r=Math.max(0,Math.min(r,e.byteLength));let n=e.byteLength-r;return t.byteLength>n&&(t=t.subarray(0,n)),e.set(t,r),t.byteLength}var Be=32*1024,at=2**32-2,ct=class{constructor(e){this._buf=e===void 0?new Uint8Array(0):new Uint8Array(e),this._off=0}bytes(e={copy:!0}){return e.copy===!1?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(e){if(e===0){this.reset();return}if(e<0||e>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+e)}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(e){let r=this._buf.byteLength;return e<=this.capacity-r?(this._reslice(r+e),r):-1}_reslice(e){this._buf=new Uint8Array(this._buf.buffer,0,e)}readSync(e){if(this.empty())return this.reset(),e.byteLength===0?0:null;let r=_e(this._buf.subarray(this._off),e);return this._off+=r,r}read(e){let r=this.readSync(e);return Promise.resolve(r)}writeSync(e){let r=this._grow(e.byteLength);return _e(e,this._buf,r)}write(e){let r=this.writeSync(e);return Promise.resolve(r)}_grow(e){let r=this.length;r===0&&this._off!==0&&this.reset();let n=this._tryGrowByReslice(e);if(n>=0)return n;let i=this.capacity;if(e<=Math.floor(i/2)-r)_e(this._buf.subarray(this._off),this._buf);else{if(i+e>at)throw new Error("The buffer cannot be grown beyond the maximum size.");{let o=new Uint8Array(Math.min(2*i+e,at));_e(this._buf.subarray(this._off),o),this._buf=o}}return this._off=0,this._reslice(Math.min(r+e,at)),r}grow(e){if(e<0)throw Error("Buffer.grow: negative count");let r=this._grow(e);this._reslice(r)}async readFrom(e){let r=0,n=new Uint8Array(Be);for(;;){let i=this.capacity-this.length<Be,o=i?n:new Uint8Array(this._buf.buffer,this.length),f=await e.read(o);if(f===null)return r;i?this.writeSync(o.subarray(0,f)):this._reslice(this.length+f),r+=f}}readFromSync(e){let r=0,n=new Uint8Array(Be);for(;;){let i=this.capacity-this.length<Be,o=i?n:new Uint8Array(this._buf.buffer,this.length),f=e.readSync(o);if(f===null)return r;i?this.writeSync(o.subarray(0,f)):this._reslice(this.length+f),r+=f}}};var we=class{constructor(e){this.codec=e}encoder(e){return new Xt(e,this.codec)}decoder(e){return new Zt(e,this.codec.decoder(e))}},Xt=class{constructor(e,r){this.w=e,this.codec=r}async encode(e){let r=new ct;await this.codec.encoder(r).encode(e);let i=new DataView(new ArrayBuffer(4));i.setUint32(0,r.length);let o=new Uint8Array(r.length+4);o.set(new Uint8Array(i.buffer),0),o.set(r.bytes(),4);let f=0;for(;f<o.length;)f+=await this.w.write(o.subarray(f))}},Zt=class{constructor(e,r){this.r=e,this.dec=r}async decode(e){let r=new Uint8Array(4);if(await this.r.read(r)===null)return null;let o=new DataView(r.buffer).getUint32(0);return await this.dec.decode(o)}};var ge=class{constructor(e,r){this.session=e,this.codec=r}async call(e,r){let n=await this.session.open();try{let i=new we(this.codec),o=i.encoder(n),f=i.decoder(n);await o.encode({Selector:e}),await o.encode(r);let m=await f.decode(),g=new lt(n,i);if(g.error=m.Error,g.error!==void 0&&g.error!==null)throw g.error;return g.reply=await f.decode(),g.continue=m.Continue,g.continue||await n.close(),g}catch(i){return await n.close(),console.error(i,e,r),Promise.reject(i)}}};function er(t){function e(r,n){return new Proxy(Object.assign(()=>{},{path:r,callable:n}),{get(i,o,f){return o.startsWith("__")?Reflect.get(i,o,f):e(i.path?`${i.path}.${o}`:o,i.callable)},apply(i,o,f=[]){return i.callable(i.path,f)}})}return e("",(r,n)=>t.call(r,n).then(i=>i.reply))}function ft(t){return{respondRPC:t}}function kr(){return ft((t,e)=>{t.return(new Error(`not found: ${e.selector}`))})}function dt(t){return t===""?"/":(t[0]!="/"&&(t="/"+t),t=t.replace(".","/"),t)}var be=class{constructor(){this.handlers={}}async respondRPC(e,r){await this.handler(r).respondRPC(e,r)}handler(e){let r=this.match(e.selector);return r||kr()}remove(e){e=dt(e);let r=this.match(e);return delete this.handlers[e],r||null}match(e){return e=dt(e),this.handlers.hasOwnProperty(e)?this.handlers[e]:null}handle(e,r){if(e==="")throw"invalid selector";if(e=dt(e),!r)throw"invalid handler";if(this.match(e))throw"selector already registered";this.handlers[e]=r}};async function tr(t,e,r){let n=new we(e),i=n.decoder(t),o=await i.decode(),f=new ut(o.Selector,i);f.caller=new ge(t.session,e);let m=new ht,g=new rr(t,n,m);return r||(r=new be),await r.respondRPC(g,f),g.responded||await g.return(null),Promise.resolve()}var rr=class{constructor(e,r,n){this.ch=e,this.codec=r,this.header=n,this.responded=!1}send(e){return this.codec.encoder(this.ch).encode(e)}return(e){return this.respond(e,!1)}async continue(e){return await this.respond(e,!0),this.ch}async respond(e,r){return this.responded=!0,this.header.Continue=r,e instanceof Error&&(this.header.Error=e.message,e=null),await this.send(this.header),await this.send(e),r||await this.ch.close(),Promise.resolve()}};var ut=class{constructor(e,r){this.selector=e,this.decoder=r}receive(){return this.decoder.decode()}},ht=class{constructor(){this.Error=void 0,this.Continue=!1}},lt=class{constructor(e,r){this.channel=e,this.codec=r,this.error=void 0,this.continue=!1}send(e){this.codec.encoder(this.channel).encode(e)}receive(){return this.codec.decoder(this.channel).decode()}};var yt=class{constructor(e,r){this.session=e,this.codec=r,this.caller=new ge(e,r),this.responder=new be}async respond(){for(;;){let e=await this.session.accept();if(e===null)break;tr(e,this.codec,this.responder)}}async call(e,r){return this.caller.call(e,r)}handle(e,r){this.responder.handle(e,r)}respondRPC(e,r){this.responder.respondRPC(e,r)}virtualize(){return er(this.caller)}};var X=100,Z=101,Q=102,re=103,ee=104,ne=105,$=106,nr=new Map([[X,12],[Z,16],[Q,4],[re,8],[ee,8],[ne,4],[$,4]]);var pt=class{constructor(e){this.w=e}async encode(e){de.messages&&console.log("<<ENC",e);let r=Br(e);de.bytes&&console.log("<<ENC",r);let n=0;for(;n<r.length;)n+=await this.w.write(r.subarray(n));return n}};function Br(t){if(t.ID===$){let e=t,r=new DataView(new ArrayBuffer(5));return r.setUint8(0,e.ID),r.setUint32(1,e.channelID),new Uint8Array(r.buffer)}if(t.ID===ee){let e=t,r=new DataView(new ArrayBuffer(9));r.setUint8(0,e.ID),r.setUint32(1,e.channelID),r.setUint32(5,e.length);let n=new Uint8Array(9+e.length);return n.set(new Uint8Array(r.buffer),0),n.set(e.data,9),n}if(t.ID===ne){let e=t,r=new DataView(new ArrayBuffer(5));return r.setUint8(0,e.ID),r.setUint32(1,e.channelID),new Uint8Array(r.buffer)}if(t.ID===X){let e=t,r=new DataView(new ArrayBuffer(13));return r.setUint8(0,e.ID),r.setUint32(1,e.senderID),r.setUint32(5,e.windowSize),r.setUint32(9,e.maxPacketSize),new Uint8Array(r.buffer)}if(t.ID===Z){let e=t,r=new DataView(new ArrayBuffer(17));return r.setUint8(0,e.ID),r.setUint32(1,e.channelID),r.setUint32(5,e.senderID),r.setUint32(9,e.windowSize),r.setUint32(13,e.maxPacketSize),new Uint8Array(r.buffer)}if(t.ID===Q){let e=t,r=new DataView(new ArrayBuffer(5));return r.setUint8(0,e.ID),r.setUint32(1,e.channelID),new Uint8Array(r.buffer)}if(t.ID===re){let e=t,r=new DataView(new ArrayBuffer(9));return r.setUint8(0,e.ID),r.setUint32(1,e.channelID),r.setUint32(5,e.additionalBytes),new Uint8Array(r.buffer)}throw`marshal of unknown type: ${t}`}function Te(t,e){let r=new Uint8Array(e),n=0;return t.forEach(i=>{r.set(i,n),n+=i.length}),r}var Ie=class{constructor(){this.q=[],this.waiters=[],this.closed=!1}push(e){if(this.closed)throw"closed queue";if(this.waiters.length>0){let r=this.waiters.shift();r&&r(e);return}this.q.push(e)}shift(){return this.closed?Promise.resolve(null):new Promise(e=>{if(this.q.length>0){e(this.q.shift()||null);return}this.waiters.push(e)})}close(){this.closed||(this.closed=!0,this.waiters.forEach(e=>{e(null)}))}},xt=class{constructor(){this.readBuf=new Uint8Array(0),this.gotEOF=!1,this.readers=[]}read(e){return new Promise(r=>{let n=()=>{if(this.readBuf===void 0){r(null);return}if(this.readBuf.length==0){if(this.gotEOF){this.readBuf=void 0,r(null);return}this.readers.push(n);return}let i=this.readBuf.slice(0,e.length);this.readBuf=this.readBuf.slice(i.length),this.readBuf.length==0&&this.gotEOF&&(this.readBuf=void 0),e.set(i),r(i.length)};n()})}write(e){for(this.readBuf&&(this.readBuf=Te([this.readBuf,e],this.readBuf.length+e.length));!this.readBuf||this.readBuf.length>0;){let r=this.readers.shift();if(!r)break;r()}return Promise.resolve(e.length)}eof(){this.gotEOF=!0,this.flushReaders()}close(){this.readBuf=void 0,this.flushReaders()}flushReaders(){for(;;){let e=this.readers.shift();if(!e)return;e()}}};var wt=class{constructor(e){this.r=e}async decode(){let e=await Fr(this.r);if(e===null)return Promise.resolve(null);de.bytes&&console.log(">>DEC",e);let r=Wr(e);return de.messages&&console.log(">>DEC",r),r}};async function Fr(t){let e=new Uint8Array(1);if(await t.read(e)===null)return Promise.resolve(null);let n=e[0],i=nr.get(n);if(i===void 0||n<X||n>$)return Promise.reject(`bad packet: ${n}`);let o=new Uint8Array(i);if(await t.read(o)===null)return Promise.reject("unexpected EOF");if(n===ee){let g=new DataView(o.buffer).getUint32(4),x=new Uint8Array(g);return await t.read(x)===null?Promise.reject("unexpected EOF"):Te([e,o,x],g+o.length+1)}return Te([e,o],o.length+1)}function Wr(t){let e=new DataView(t.buffer);switch(t[0]){case $:return{ID:t[0],channelID:e.getUint32(1)};case ee:let r=e.getUint32(5),n=new Uint8Array(t.buffer.slice(9));return{ID:t[0],channelID:e.getUint32(1),length:r,data:n};case ne:return{ID:t[0],channelID:e.getUint32(1)};case X:return{ID:t[0],senderID:e.getUint32(1),windowSize:e.getUint32(5),maxPacketSize:e.getUint32(9)};case Z:return{ID:t[0],channelID:e.getUint32(1),senderID:e.getUint32(5),windowSize:e.getUint32(9),maxPacketSize:e.getUint32(13)};case Q:return{ID:t[0],channelID:e.getUint32(1)};case re:return{ID:t[0],channelID:e.getUint32(1),additionalBytes:e.getUint32(5)};default:throw`unmarshal of unknown type: ${t[0]}`}}var de={messages:!1,bytes:!1};var gt=9,bt=Number.MAX_VALUE,It=class{constructor(e){this.conn=e,this.enc=new pt(e),this.dec=new wt(e),this.channels=[],this.incoming=new Ie,this.done=this.loop()}async open(){let e=this.newChannel();if(e.maxIncomingPayload=Ve,await this.enc.encode({ID:X,windowSize:e.myWindow,maxPacketSize:e.maxIncomingPayload,senderID:e.localId}),await e.ready.shift())return e;throw"failed to open"}accept(){return this.incoming.shift()}async close(){for(let e of Object.keys(this.channels)){let r=parseInt(e);this.channels[r]!==void 0&&this.channels[r].shutdown()}this.conn.close(),await this.done}async loop(){try{for(;;){let e=await this.dec.decode();if(e===null){this.close();return}if(e.ID===X){await this.handleOpen(e);continue}let r=e,n=this.getCh(r.channelID);if(n===void 0)throw`invalid channel (${r.channelID}) on op ${r.ID}`;await n.handle(r)}}catch(e){throw new Error(`session loop: ${e}`)}}async handleOpen(e){if(e.maxPacketSize<gt||e.maxPacketSize>bt){await this.enc.encode({ID:Q,channelID:e.senderID});return}let r=this.newChannel();r.remoteId=e.senderID,r.maxRemotePayload=e.maxPacketSize,r.remoteWin=e.windowSize,r.maxIncomingPayload=Ve,this.incoming.push(r),await this.enc.encode({ID:Z,channelID:r.remoteId,senderID:r.localId,windowSize:r.myWindow,maxPacketSize:r.maxIncomingPayload})}newChannel(){let e=new At(this);return e.remoteWin=0,e.myWindow=sr,e.localId=this.addCh(e),e}getCh(e){let r=this.channels[e];return r&&r.localId!==e&&console.log("bad ids:",e,r.localId,r.remoteId),r}addCh(e){return this.channels.forEach((r,n)=>{if(r===void 0)return this.channels[n]=e,n}),this.channels.push(e),this.channels.length-1}rmCh(e){delete this.channels[e]}};var Ve=1<<15,sr=64*Ve,At=class{constructor(e){this.localId=0,this.remoteId=0,this.maxIncomingPayload=0,this.maxRemotePayload=0,this.sentEOF=!1,this.sentClose=!1,this.remoteWin=0,this.myWindow=0,this.ready=new Ie,this.session=e,this.writers=[],this.readBuf=new xt}ident(){return this.localId}async read(e){let r=await this.readBuf.read(e);if(r!==null)try{await this.adjustWindow(r)}catch(n){if(n!=="EOF")throw n}return r}write(e){return this.sentEOF?Promise.reject("EOF"):new Promise((r,n)=>{let i=0,o=()=>{if(this.sentEOF||this.sentClose){n("EOF");return}if(e.byteLength==0){r(i);return}let f=Math.min(this.maxRemotePayload,e.length),m=this.reserveWindow(f);if(m==0){this.writers.push(o);return}let g=e.slice(0,m);this.send({ID:ee,channelID:this.remoteId,length:g.length,data:g}).then(()=>{if(i+=g.length,e=e.slice(g.length),e.length==0){r(i);return}this.writers.push(o)})};o()})}reserveWindow(e){return this.remoteWin<e&&(e=this.remoteWin),this.remoteWin-=e,e}addWindow(e){for(this.remoteWin+=e;this.remoteWin>0;){let r=this.writers.shift();if(!r)break;r()}}async closeWrite(){this.sentEOF=!0,await this.send({ID:ne,channelID:this.remoteId}),this.writers.forEach(e=>e()),this.writers=[]}async close(){if(!this.sentClose){for(await this.send({ID:$,channelID:this.remoteId}),this.sentClose=!0;await this.ready.shift()!==null;);return}this.shutdown()}shutdown(){this.readBuf.close(),this.writers.forEach(e=>e()),this.ready.close(),this.session.rmCh(this.localId)}async adjustWindow(e){this.myWindow+=e,await this.send({ID:re,channelID:this.remoteId,additionalBytes:e})}send(e){if(this.sentClose)throw"EOF";return this.sentClose=e.ID===$,this.session.enc.encode(e)}handle(e){if(e.ID===ee){this.handleData(e);return}if(e.ID===$){this.close();return}if(e.ID===ne&&this.readBuf.eof(),e.ID===Q){this.session.rmCh(e.channelID),this.ready.push(!1);return}if(e.ID===Z){if(e.maxPacketSize<gt||e.maxPacketSize>bt)throw"invalid max packet size";this.remoteId=e.senderID,this.maxRemotePayload=e.maxPacketSize,this.addWindow(e.windowSize),this.ready.push(!0);return}e.ID===re&&this.addWindow(e.additionalBytes)}handleData(e){if(e.length>this.maxIncomingPayload)throw"incoming packet exceeds maximum payload size";if(this.myWindow<e.length)throw"remote side wrote too much";this.myWindow-=e.length,this.readBuf.write(e.data)}};var St={};ar(St,{Conn:()=>Dt,connect:()=>Vr});function Vr(t,e){return new Promise(r=>{let n=new WebSocket(t);n.onopen=()=>r(new Dt(n)),e&&(n.onclose=e)})}var Dt=class{constructor(e){this.isClosed=!1,this.waiters=[],this.chunks=[],this.ws=e,this.ws.binaryType="arraybuffer",this.ws.onmessage=n=>{let i=new Uint8Array(n.data);if(this.chunks.push(i),this.waiters.length>0){let o=this.waiters.shift();o&&o()}};let r=this.ws.onclose;this.ws.onclose=n=>{r&&r.bind(this.ws)(n),this.close()}}read(e){return new Promise(r=>{var n=()=>{if(this.isClosed){r(null);return}if(this.chunks.length===0){this.waiters.push(n);return}let i=0;for(;i<e.length;){let o=this.chunks.shift();if(o==null){r(null);return}let f=o.slice(0,e.length-i);if(e.set(f,i),i+=f.length,o.length>f.length){let m=o.slice(f.length);this.chunks.unshift(m)}}r(i)};n()})}write(e){return this.ws.send(e),Promise.resolve(e.byteLength)}close(){this.isClosed||(this.isClosed=!0,this.waiters.forEach(e=>e()),this.ws.close())}};var Lr={transport:St};async function Ln(t,e){let r=await Lr.transport.connect(t);return vr(r,e)}function vr(t,e,r){let n=new It(t),i=new yt(n,e);if(r){for(let o in r)i.handle(o,ft(r[o]));i.respond()}return i}export{ct as Buffer,Rr as CBORCodec,Yt as CBORDecoder,Jt as CBOREncoder,ut as Call,At as Channel,ge as Client,we as FrameCodec,Zt as FrameDecoder,Xt as FrameEncoder,ft as HandlerFunc,cr as JSONCodec,Pt as JSONDecoder,Ot as JSONEncoder,kr as NotFoundHandler,yt as Peer,tr as Respond,be as RespondMux,lt as Response,ht as ResponseHeader,It as Session,er as VirtualCaller,Ve as channelMaxPacket,sr as channelWindowSize,Ln as connect,bt as maxPacketLength,gt as minPacketLength,vr as open,Lr as options};
